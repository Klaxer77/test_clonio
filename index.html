<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Snake Smooth Multiplayer</title>
  <style>
    html,body{
      margin:0;padding:0;
      overflow:hidden;
      font-family:Arial,sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      color:white;
      height:100%;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
      touch-action: none;
    }
    body{ position:fixed; inset:0; }
    canvas{ display:block; outline:none; touch-action:none; }
    #menu{
      position:fixed;inset:0;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      background: rgba(0,0,0,0.82);
      gap:14px;text-align:center;padding:24px;box-sizing:border-box;
      z-index:30;
      touch-action:none;
    }
    button{font-size:24px;padding:15px 40px;cursor:pointer;border:none;background:lime;color:black;border-radius:10px;}
    button:hover{background:#7CFF7C;}
    .hud{
      position:fixed;left:12px;top:10px;z-index:25;
      font-size:14px;opacity:.85;user-select:none;pointer-events:none;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      line-height:1.35;white-space:pre;
    }

    #touchUI{
      position:fixed; inset:0; z-index:20;
      display:none;
      pointer-events:none;
      touch-action:none;
    }

    #joyWrap{
      position:absolute;
      pointer-events:auto; touch-action:none;
      left: max(39px, env(safe-area-inset-left));
      bottom: calc(26px + env(safe-area-inset-bottom));
      width:150px; height:150px;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    #joyBase{
      width:100%; height:100%;
      border-radius:999px;
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(4px);
      position:relative;
    }
    #joyKnob{
      position:absolute; left:50%; top:50%;
      width:54px; height:54px;
      margin-left:-27px; margin-top:-27px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      border:1px solid rgba(255,255,255,0.25);
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      transform:translate(0,0);
      will-change:transform;
    }

    #btnWrap{
      position:absolute;
      pointer-events:auto; touch-action:none;
      right: max(10px, env(safe-area-inset-right));
      bottom: calc(34px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; gap:12px;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    #boostBtn,.boostBtn{
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      -webkit-tap-highlight-color:transparent;
      outline:none; -webkit-appearance:none; appearance:none;
      caret-color:transparent;
      touch-action:none;
    }
    #boostBtn:focus,#boostBtn:focus-visible{ outline:none; }

    .boostBtn{
      width:86px; height:86px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:38px; font-weight:700;
      background: rgba(255, 208, 64, 0.34);
      border: 1px solid rgba(255, 225, 120, 0.34);
      backdrop-filter: blur(4px);
      color:#111;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      -webkit-tap-highlight-color: transparent;
    }
    .boostBtn .icon{ display:block; line-height:1; pointer-events:none; user-select:none; }
    .boostBtn:active{
      transform: scale(0.96);
      box-shadow: 0 6px 14px rgba(0,0,0,.28);
    }

    @media (pointer:coarse){
      .hud{top:8px;left:10px;font-size:12px;opacity:.78;}
    }
  </style>
</head>
<body>
  <div id="menu">
    <h1>üêç Snake</h1>
    <button id="playBtn">–ò–≥—Ä–∞—Ç—å</button>
  </div>

  <div id="hud" class="hud" style="display:none"></div>

  <canvas id="game" tabindex="0" style="display:none"></canvas>

  <div id="touchUI" aria-hidden="true">
    <div id="joyWrap">
      <div id="joyBase"><div id="joyKnob"></div></div>
    </div>
    <div id="btnWrap">
      <button id="boostBtn" class="boostBtn" aria-label="–£—Å–∫–æ—Ä–µ–Ω–∏–µ">
        <span class="icon" aria-hidden="true">‚ö°</span>
      </button>
    </div>
  </div>

<script>
  document.addEventListener("touchmove", (e)=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener("gesturestart", (e)=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener("gesturechange",(e)=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener("gestureend",   (e)=>{ e.preventDefault(); }, {passive:false});
  window.addEventListener("scroll", ()=>window.scrollTo(0,0), {passive:true});

  const WORLD_W = 3000, WORLD_H = 3000;
  const SEGMENT = 30;
  const ROOM_ID = "room1";

  const CLIENT_SPEED = 4;
  const SEG_DIST = SEGMENT * 0.85;

  let ws=null, playerId=null, foods=[], cameraX=0, cameraY=0;
  let dir = {x:1, y:0}, dead=false;

  let deathAtMs = null;
  let lastMeHead = null;
  let lastMeHeadTs = null;
  let lastMeVel = { vx: 0, vy: 0 };
  const DEATH_FADE_MS = 650;
  const DEATH_HOLD_MS = 520;
  let deathMenuTimer = null;

  let useMouse = false;
  let useTouch = false;

  let serverBoosting = false;
  const keysDown = new Set();
  let lastAxisX = 1;
  let lastAxisY = -1;

  const menu=document.getElementById("menu"),
        playBtn=document.getElementById("playBtn"),
        canvas=document.getElementById("game"),
        hud=document.getElementById("hud"),
        ctx=canvas.getContext("2d");

  const touchUI = document.getElementById("touchUI");
  const joyWrap = document.getElementById("joyWrap");
  const joyKnob = document.getElementById("joyKnob");
  const boostBtn = document.getElementById("boostBtn");

  const isTouchDevice =
    (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
    ("ontouchstart" in window) ||
    (navigator.maxTouchPoints > 0);

  function wsUrl(path){
    return `wss://${location.host}${path}`;
  }

  function clamp01(v){ return Math.max(-1, Math.min(1, v)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function smoothstep01(t){
    t = clamp(t, 0, 1);
    return t*t*(3 - 2*t);
  }
  function normAngle(a){
    while(a > Math.PI) a -= Math.PI*2;
    while(a < -Math.PI) a += Math.PI*2;
    return a;
  }

  /* ===== VIEW / SNAKE SIZE ===== */
  const DESKTOP_SNAKE_SCALE = 1.35;
  const MOBILE_VIEW_ZOOM    = 0.82;
  const MOBILE_SNAKE_SCALE  = 1.29;

  let SNAKE_SCALE = DESKTOP_SNAKE_SCALE;
  let GRID_STEP = Math.round(SEGMENT * 2.4);
  let VIEW_ZOOM = 1;

  /* FPS */
  let lastFpsTs = performance.now();
  let frames = 0;
  let lowDetail = false;
  let fps = 60;

  function updateFpsOnRenderedFrame(timeMs){
    frames++;
    const dt = timeMs - lastFpsTs;
    if(dt >= 500){
      fps = Math.round((frames * 1000) / dt);
      frames = 0;
      lastFpsTs = timeMs;
      lowDetail = fps < 45;
      GRID_STEP = Math.round(SEGMENT * (lowDetail ? 3.2 : 2.4));
    }
  }

  /* CANVAS SIZE */
  let VIEW_W = innerWidth, VIEW_H = innerHeight;

  function fitCanvas(){
    const vv = window.visualViewport;
    const w = vv ? Math.round(vv.width)  : innerWidth;
    const h = vv ? Math.round(vv.height) : innerHeight;
    VIEW_W = w; VIEW_H = h;
    if(isTouchDevice){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      canvas.width  = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.imageSmoothingEnabled = true;
    } else {
      canvas.width = w;
      canvas.height = h;
      ctx.setTransform(1,0,0,1,0,0);
    }
  }
  window.addEventListener("resize", fitCanvas);
  window.visualViewport?.addEventListener("resize", fitCanvas);
  window.visualViewport?.addEventListener("scroll", fitCanvas);

  /* FOOD */
  let FOOD_WOBBLE_PX = 7.5;
  const FOOD_WOBBLE_SPEED = 0.0036;
  let EAT_RADIUS = SEGMENT * 0.70;
  let EAT_SIDE_MULT = 2.0;   // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å–±–æ—Ä–∞ –µ–¥—ã
  let EAT_FWD_MULT  = 1.05;  // –£–º–µ–Ω—å—à–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø–æ –¥–ª–∏–Ω–µ
</script>
</body>
</html>
