<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Snake Smooth Multiplayer</title>
  <style>
    html,body{
      margin:0;padding:0;
      overflow:hidden;
      font-family:Arial,sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      color:white;
      height:100%;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
      touch-action: none;
    }
    body{ position:fixed; inset:0; }
    canvas{ display:block; outline:none; touch-action:none; }
    #menu{
      position:fixed;inset:0;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      background: rgba(0,0,0,0.82);
      gap:14px;text-align:center;padding:24px;box-sizing:border-box;
      z-index:30;
      touch-action:none;
    }
    button{font-size:24px;padding:15px 40px;cursor:pointer;border:none;background:lime;color:black;border-radius:10px;}
    button:hover{background:#7CFF7C;}
    .hud{
      position:fixed;left:12px;top:10px;z-index:25;
      font-size:14px;opacity:.85;user-select:none;pointer-events:none;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      line-height:1.35;white-space:pre;
    }

    #touchUI{
      position:fixed; inset:0; z-index:20;
      display:none;
      pointer-events:none;
      touch-action:none;
    }

    #joyWrap{
      position:absolute;
      pointer-events:auto; touch-action:none;
      left: max(39px, env(safe-area-inset-left));
      bottom: calc(26px + env(safe-area-inset-bottom));
      width:150px; height:150px;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    #joyBase{
      width:100%; height:100%;
      border-radius:999px;
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(4px);
      position:relative;
    }
    #joyKnob{
      position:absolute; left:50%; top:50%;
      width:54px; height:54px;
      margin-left:-27px; margin-top:-27px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      border:1px solid rgba(255,255,255,0.25);
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      transform:translate(0,0);
      will-change:transform;
    }

    #btnWrap{
      position:absolute;
      pointer-events:auto; touch-action:none;
      right: max(50px, env(safe-area-inset-right));
      bottom: calc(74px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; gap:12px;
      -webkit-user-select:none; user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    #boostBtn,.boostBtn{
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      -webkit-tap-highlight-color:transparent;
      outline:none; -webkit-appearance:none; appearance:none;
      caret-color:transparent;
      touch-action:none;
    }
    #boostBtn:focus,#boostBtn:focus-visible{ outline:none; }

    .boostBtn{
      width:86px; height:86px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:38px; font-weight:700;
      background: rgba(255, 208, 64, 0.34);
      border: 1px solid rgba(255, 225, 120, 0.34);
      backdrop-filter: blur(4px);
      color:#111;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      -webkit-tap-highlight-color: transparent;
    }
    .boostBtn .icon{ display:block; line-height:1; pointer-events:none; user-select:none; }
    .boostBtn:active{
      transform: scale(0.96);
      box-shadow: 0 6px 14px rgba(0,0,0,.28);
    }

    @media (pointer:coarse){
      .hud{top:8px;left:10px;font-size:12px;opacity:.78;}
    }
  </style>
</head>
<body>
  <div id="menu">
    <h1>üêç Snake</h1>
    <button id="playBtn">–ò–≥—Ä–∞—Ç—å</button>
  </div>

  <div id="hud" class="hud" style="display:none"></div>

  <canvas id="game" tabindex="0" style="display:none"></canvas>

  <div id="touchUI" aria-hidden="true">
    <div id="joyWrap">
      <div id="joyBase"><div id="joyKnob"></div></div>
    </div>
    <div id="btnWrap">
      <button id="boostBtn" class="boostBtn" aria-label="–£—Å–∫–æ—Ä–µ–Ω–∏–µ">
        <span class="icon" aria-hidden="true">‚ö°</span>
      </button>
    </div>
  </div>

<script>
  document.addEventListener("touchmove", (e) => e.preventDefault(), {passive:false});
  document.addEventListener("gesturestart", (e) => e.preventDefault(), {passive:false});
  document.addEventListener("gesturechange", (e) => e.preventDefault(), {passive:false});
  document.addEventListener("gestureend", (e) => e.preventDefault(), {passive:false});
  window.addEventListener("scroll", () => window.scrollTo(0, 0), {passive:true});

  const WORLD_W = 3000, WORLD_H = 3000;
  const SEGMENT = 30;
  const ROOM_ID = "room1";
  
  let ws = null, playerId = null, foods = [], cameraX = 0, cameraY = 0;
  let dir = {x: 1, y: 0}, dead = false;

  const menu = document.getElementById("menu"),
        playBtn = document.getElementById("playBtn"),
        canvas = document.getElementById("game"),
        hud = document.getElementById("hud"),
        ctx = canvas.getContext("2d");

  const touchUI = document.getElementById("touchUI");
  const joyWrap = document.getElementById("joyWrap");
  const joyKnob = document.getElementById("joyKnob");
  const boostBtn = document.getElementById("boostBtn");

  function wsUrl(path){
    return `wss://${location.host}${path}`;
  }

  playBtn.addEventListener("click", startGame);

  function startGame() {
    if (ws) {
      ws.close();
      ws = null;
    }

    dead = false;
    cameraX = cameraY = 0;
    dir = {x: 1, y: 0};

    menu.style.display = "none";
    canvas.style.display = "block";
    hud.style.display = "block";

    playerId = "player" + Math.floor(Math.random() * 9999);
    ws = new WebSocket(wsUrl(`/ws/${ROOM_ID}/${playerId}`));
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      startRttPing();
      startInputHeartbeat();
    };

    ws.onmessage = (e) => {
      let data = null;

      if (e.data instanceof ArrayBuffer) {
        const txt = new TextDecoder().decode(new Uint8Array(e.data));
        data = JSON.parse(txt);
      } else if (typeof e.data === "string") {
        data = JSON.parse(e.data);
      }

      if (data.type === "pong") {
        const now = performance.now();
        const sample = Math.max(0, now - (data.t || now));
        rtt = rtt * 0.8 + sample * 0.2;
        return;
      }

      if (data.type === "death") {
        dead = true;
        sendBoost(false);

        const now = performance.now();
        if (deathAtMs == null) deathAtMs = now;

        if (deathMenuTimer) clearTimeout(deathMenuTimer);
        deathMenuTimer = setTimeout(() => {
          try {
            ws?.close?.();
          } catch (_e) {}
          canvas.style.display = "none";
          hud.style.display = "none";
          menu.style.display = "flex";
        }, DEATH_HOLD_MS);

        return;
      }

      if (data.type === "snapshot") {
        const pl = data.players || {};
        for (const id in pl) {
          const it = pl[id];
          const r = remote[id] || (remote[id] = { path: [], bodyKF: null, lastV: 0, len: 10, lenF: 10, boost: 0, color: "white", head: null, dir: null, dirS: null, lastNetTs: null, snaps: [] });
          r.color = it.color || r.color;
          r.boost = !!it.boost;
        }
        if (Array.isArray(data.foods)) {
          foods = data.foods;
          markFoodBirths(foods, performance.now());
        }
        return;
      }

      if (data.type === "state" && data.players) {
        const pl = data.players;
        const seen = new Set(Object.keys(pl));
        for (const id in remote) {
          if (id === playerId) continue;
          if (!seen.has(id)) delete remote[id];
        }

        const nowMs = performance.now();

        for (const id in pl) {
          const it = pl[id];
          const r = remote[id] || (remote[id] = { path: [], bodyKF: null, lastV: 0, len: 10, lenF: 10, boost: 0, color: "white", head: null, dir: null, dirS: null, lastNetTs: null, snaps: [] });

          r.lenF = (typeof it.lf === "number") ? it.lf : (it.l | 0);
          r.len = it.l | 0;
          r.boost = !!it.b;
          r.color = it.c || r.color;

          if (Array.isArray(it.h)) r.head = { x: it.h[0], y: it.h[1] };
          if (Array.isArray(it.u)) r.dir = { x: it.u[0], y: it.u[1] };

          const hasKF = !!it.kf && Array.isArray(it.body) && it.body.length >= 4;
          let skipPtThisTick = false;

          if (hasKF) {
            r.bodyKF = it.body;
            const kfSnake = snakePointsFromFlatBody(it.body);
            r.path = kfSnake.slice();
            r.lastV = (it.pv | 0);

            const netSnake = buildSnakeFromPath(r.path, r.lenF);
            pushSnap(r, netSnake, nowMs);

            skipPtThisTick = true;
          }

          if (!skipPtThisTick && Array.isArray(it.pt) && it.pt.length) {
            const basePrevV = (r.lastV | 0);

            let maxV = (r.lastV | 0);
            const newPts = [];

            for (let j = 0; j < it.pt.length; j++) {
              const n = it.pt[j];
              const v = n[0] | 0;
              if (v <= basePrevV) continue;

              const x = +n[1], y = +n[2];

              if (r.path && r.path.length) {
                const hx = r.path[0].x, hy = r.path[0].y;
                const dx = x - hx, dy = y - hy;
                if (dx * dx + dy * dy < 0.01) {
                  if (v > maxV) maxV = v;
                  continue;
                }
              }

              newPts.push({ x, y, v });
              if (v > maxV) maxV = v;
            }

            for (let k = newPts.length - 1; k >= 0; k--) {
              r.path.unshift({ x: newPts[k].x, y: newPts[k].y });
            }

            if (r.path.length > REMOTE_PATH_MAX) r.path.length = REMOTE_PATH_MAX;
            r.lastV = maxV;

            let sourcePath = (r.path && r.path.length >= 2) ? r.path : null;
            if (!sourcePath && Array.isArray(r.bodyKF) && r.bodyKF.length >= 4) {
              sourcePath = snakePointsFromFlatBody(r.bodyKF);
            }
            if (sourcePath && sourcePath.length >= 2) {
              const netSnake = buildSnakeFromPath(sourcePath, r.lenF);
              pushSnap(r, netSnake, nowMs);
            }
          }

          r.lastNetTs = nowMs;
        }

        if (Array.isArray(data.foods)) {
          foods = data.foods;
          markFoodBirths(foods, performance.now());
        }
      }
    };

    ws.onclose = () => {
      if (rttTimer) { clearInterval(rttTimer); rttTimer = null; }
      if (inputTimer) { clearInterval(inputTimer); inputTimer = null; }
      sendBoost(false);
      touchUI.style.display = "none";
      touchUI.setAttribute("aria-hidden", "true");

      if (dead) return;

      canvas.style.display = "none";
      hud.style.display = "none";
      menu.style.display = "flex";
    };
  }

  function sendBoost(state) {
    if (!ws) return;
    if (ws.readyState !== 1) return;
    if (state === serverBoosting) return;
    serverBoosting = state;
    ws.send(JSON.stringify({ boost: state }));
  }

</script>
</body>
</html>
